package main

import (
	"context"
	"fmt"
	"os"
	"path/filepath"
	"time"
	"github.com/st3v3nmw/sourcerer-mcp/internal/analyzer"
)

func main() {
	fmt.Println("=== Sourcerer Memory System Integration Test ===\n")
	
	// Use the actual test project directory
	testDir := "/Users/claudeuser/claude_home/test_project"
	
	fmt.Printf("1. Testing with directory: %s\n", testDir)
	
	// Check directory exists and has files
	files, err := filepath.Glob(filepath.Join(testDir, "*.md"))
	if err != nil || len(files) == 0 {
		fmt.Printf("❌ FAILED: No markdown files found in %s\n", testDir)
		os.Exit(1)
	}
	fmt.Printf("   ✓ Found %d markdown files\n", len(files))
	
	// Create analyzer
	fmt.Println("\n2. Creating analyzer and loading index...")
	a, err := analyzer.New(context.Background(), testDir)
	if err != nil {
		fmt.Printf("❌ FAILED: Couldn't create analyzer: %v\n", err)
		os.Exit(1)
	}
	fmt.Println("   ✓ Analyzer created successfully")
	
	// Index the workspace
	fmt.Println("\n3. Indexing workspace files...")
	a.IndexWorkspace(context.Background())
	fmt.Println("   ✓ Indexing started")
	
	// Give it time to finish indexing
	fmt.Println("   Waiting for indexing to complete...")
	time.Sleep(3 * time.Second)



// After indexing, before searching - add this:
fmt.Println("\n3.5. Testing what file_types find the content...")

docsResults, _ := a.SemanticSearch(context.Background(), "design choices", []string{"docs"})
fmt.Printf("   Searching file_types=[\"docs\"]: Found %d results\n", len(docsResults))

memResults, _ := a.SemanticSearch(context.Background(), "design choices", []string{"memory"})  
fmt.Printf("   Searching file_types=[\"memory\"]: Found %d results\n", len(memResults))


srcResults, _ := a.SemanticSearch(context.Background(), "design choices", []string{"src"})
fmt.Printf("   Searching file_types=[\"src\"]: Found %d results\n", len(srcResults))



// After line "3.5. Testing what file_types find the content..."
memResults, _ = a.SemanticSearch(context.Background(), "design choices", []string{"memory"})
fmt.Printf("   Memory results: %d\n", len(memResults))
for i, r := range memResults {
    preview := r
    if len(preview) > 80 {
        preview = preview[:80] + "..."
    }
    fmt.Printf("     [%d] %s\n", i+1, preview)
}

srcResults, _ = a.SemanticSearch(context.Background(), "design choices", []string{"src"})
fmt.Printf("   Src results: %d\n", len(srcResults))
for i, r := range srcResults {
    preview := r
    if len(preview) > 80 {
        preview = preview[:80] + "..."
    }
    fmt.Printf("     [%d] %s\n", i+1, preview)
}



	// Test semantic search for memory
	fmt.Println("\n4. Testing semantic search for project decisions...")
	results, err := a.SemanticSearch(context.Background(), "why did we choose Python", []string{"memory"})
	if err != nil {
		fmt.Printf("❌ FAILED: Search failed: %v\n", err)
		os.Exit(1)
	}
	
	if len(results) == 0 {
		fmt.Println("⚠️  WARNING: No results found in memory files")
		fmt.Println("   This might be OK if decisions.md doesn't mention Python")
	} else {
		fmt.Printf("   ✓ Found %d results\n", len(results))
		fmt.Println("\n5. Sample result (first 200 chars):")
		if len(results[0]) > 200 {
			fmt.Printf("   %s...\n", results[0][:200])
		} else {
			fmt.Printf("   %s\n", results[0])
		}
	}
	
	// Test broader search
	fmt.Println("\n6. Testing broader semantic search (all file types)...")
	allResults, err := a.SemanticSearch(context.Background(), "Python fuzzer", []string{"src", "docs", "memory"})
	if err != nil {
		fmt.Printf("❌ FAILED: Broader search failed: %v\n", err)
		os.Exit(1)
	}
	fmt.Printf("   ✓ Found %d results across all file types\n", len(allResults))
	
	if len(allResults) > 0 {
		fmt.Println("\n7. Sample from broader search (first 150 chars):")
		if len(allResults[0]) > 150 {
			fmt.Printf("   %s...\n", allResults[0][:150])
		} else {
			fmt.Printf("   %s\n", allResults[0])
		}
	}
	
	fmt.Println("\n=== ✅ ALL TESTS PASSED ===")
	fmt.Println("\nSourcerer memory system is working correctly!")
	fmt.Println("- Ollama embeddings: ✓")
	fmt.Println("- Workspace indexing: ✓")
	fmt.Println("- Semantic search: ✓")
	fmt.Println("- Memory file indexing: ✓")
}